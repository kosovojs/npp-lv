<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <meta charset="utf-8" />
    <script
      type="text/javascript"
      src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/jquery/3.3.1/jquery.min.js"
    ></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://tools-static.wmflabs.org/cdnjs/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"
    />
    <script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
    <style>
      canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default" role="navigation">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.php">NPP</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="list.html">Saraksts</a></li>
            <li><a href="comments.html">Ar komentāriem</a></li>
            <li class="active"><a href="">Dashboard</a></li>
            <li>
              <a><span id="number-articles"></span></a>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><span id="username" class="navbar-text"></span></li>
            <li><span id="login" class="navbar-text"></span></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container-fluid -->
    </nav>
    <h3>Pārbaudāmo rakstu izmaiņa</h3>
    <div style="width:75%;">
      <canvas id="canvas" width="400" height="175"></canvas>
    </div>
    <h3>Pārbaudīto rakstu izmaiņa</h3>
    <div style="width:75%;">
      <canvas id="canvas2" width="400" height="175"></canvas>
    </div>
    <h3>Vēl pārbaudāmo rakstu sadalījums</h3>
    <div style="width:75%;">
      <canvas id="canvas3" width="400" height="175"></canvas>
    </div>
    <h3>Aktivitāte</h3>
    <div style="width:75%;">
      <canvas id="canvas4" width="400" height="175"></canvas>
    </div>
    <script>
      var days = {
        1: "Svētdiena",
        2: "Pirmdiena",
        3: "Otrdiena",
        4: "Trešdiena",
        5: "Ceturtdiena",
        6: "Piektdiena",
        7: "Sestdiena"
      };
      $(document).ready(function() {
        $.ajax({
          type: "GET",
          url: "./api.php",
          data: { action: "userinfo" }
        }).done(function(data) {
          if ("error" in data) {
            $("#username").html("");
            $("#login").html(
              '<a href="./api.php?action=authorize" target="_parent">ienākt</a>'
            );
            //$('#only_logged').html( '<div class="alert alert-warning" role="alert">Lai pievienotu rakstu, Tev ir <a class="alert-link" href="../index.php?action=authorize" target="_parent">jāielogojas</a>!</div>' );
          } else {
            $("#username").html(
              "Sveiks, " + data["query"]["userinfo"]["name"] + "!"
            );
            $("#login").html(
              '<a href="./api.php?action=logout" target="_parent">iziet</a>'
            );
          }
        });
      });

      function generate(days, articlecount) {
        var ctx = $("#canvas");

        var myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: days,
            datasets: [
              {
                backgroundColor: "rgb(255, 99, 132)",
                borderColor: "rgb(255, 99, 132)",
                label: "Atlikušie raksti",
                data: articlecount,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            tooltips: {
              mode: "index",
              intersect: false
            },
            scales: {
              xAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Laika brīdis"
                  }
                }
              ],
              yAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Rakstu skaits"
                  }
                }
              ]
            }
          }
        });
      }

      function generate2(days, articlecount) {
        var ctx = $("#canvas2");

        var myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: days,
            datasets: [
              {
                backgroundColor: "rgb(75, 192, 192)",
                borderColor: "rgb(75, 192, 192)",
                label: "Pārbaudītie raksti",
                data: articlecount,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            tooltips: {
              mode: "index",
              intersect: false
            },
            scales: {
              xAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Diena"
                  }
                }
              ],
              yAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Rakstu skaits"
                  }
                }
              ]
            }
          }
        });
      }

      function generate3(days, articlecount) {
        var ctx = $("#canvas3");

        var myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: days,
            datasets: [
              {
                backgroundColor: "rgb(255, 159, 64)",
                borderColor: "rgb(255, 159, 64)",
                label: "Izveidotie raksti",
                data: articlecount,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            tooltips: {
              mode: "index",
              intersect: false
            },
            scales: {
              xAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Diena"
                  }
                }
              ],
              yAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Rakstu skaits"
                  }
                }
              ]
            }
          }
        });
      }

      function generate4(alldata) {
        var ctx = $("#canvas4");

        var myChart = new Chart(ctx, {
          type: "bubble",
          data: {
            datasets: alldata
          },
          options: {
            legend: {
              display: false
            },
            elements: {
              point: {
                radius: function(context) {
                  var index = context.dataIndex;
                  var data = context.dataset.data[index];
                  var size = context.chart.width;
                  var base = data.value / 100;
                  return (size / 40) * base;
                }
              }
            },
            scales: {
              yAxes: [
                {
                  ticks: {
                    min: 0,
                    max: 8,
                    padding: 3 * 0.4,
                    callback: function(value, index, values) {
                      return days[index];
                    }
                  },
                  position: "left"
                }
              ],
              xAxes: [
                {
                  ticks: {
                    beginAtZero: true,
                    min: 0,
                    max: 23,
                    stepSize: 2,
                    callback: function(value, index, values) {
                      if (value % 2 === 0) {
                        return value + ":00";
                      }
                    }
                  }
                }
              ]
            },
            tooltips: {
              callbacks: {
                label: function(item) {
                  // yLabels are reversed, and zero-indexed
                  return days[7 - item.yLabel + 1] + " " + item.xLabel + ":00";
                }
              }
            }
          }
        });
      }

      $.ajax({
        type: "GET",
        url: "./api.php",
        data: { action: "graphdata" }
      }).done(function(data) {
        console.log(data);

        generate(data[0][0], data[0][1]);
        generate2(data[1][0], data[1][1]);
        generate3(data[2][0], data[2][1]);
        generate4(data[3]);
      });
    </script>
  </body>
</html>
